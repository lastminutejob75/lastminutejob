<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LastMinuteJob - Admin Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
  <div id="app" class="min-h-screen">
    <div class="max-w-7xl mx-auto px-4 py-8">

      <!-- Login/Register Form -->
      <div id="auth-section" class="max-w-md mx-auto">
        <div class="bg-white rounded-lg border p-6 shadow-sm">
          <div class="mb-6">
            <h1 class="text-2xl font-bold mb-2">LastMinuteJob</h1>
            <p class="text-sm text-gray-600">Admin Back-Office</p>
          </div>
          <div class="space-y-3">
            <div>
              <label class="block text-sm mb-1 font-medium">Email</label>
              <input type="email" id="email" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="admin@example.com">
            </div>
            <div>
              <label class="block text-sm mb-1 font-medium">Mot de passe</label>
              <input type="password" id="password" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Minimum 6 caract√®res">
            </div>
            <div class="flex gap-2">
              <button onclick="login()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">Se connecter</button>
              <button onclick="register()" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">S'inscrire</button>
            </div>
            <div id="auth-message" class="text-sm mt-2"></div>
          </div>
        </div>
      </div>

      <!-- Admin Dashboard (hidden until logged in) -->
      <div id="dashboard-section" style="display: none;">

        <!-- Header -->
        <div class="bg-white rounded-lg border p-4 mb-6 shadow-sm">
          <div class="flex items-center justify-between">
            <div>
              <h1 class="text-2xl font-bold">Admin Dashboard</h1>
              <p class="text-sm text-gray-600">Connect√©: <span id="admin-email" class="font-medium"></span></p>
            </div>
            <button onclick="logout()" class="px-4 py-2 border rounded-lg hover:bg-gray-50 font-medium">D√©connexion</button>
          </div>
        </div>

        <!-- Tabs -->
        <div class="bg-white rounded-lg border mb-6 shadow-sm">
          <div class="flex border-b">
            <button onclick="switchTab('jobs')" id="tab-jobs" class="flex-1 px-6 py-3 font-medium border-b-2 border-blue-600 text-blue-600">
              üìã Annonces
            </button>
            <button onclick="switchTab('create')" id="tab-create" class="flex-1 px-6 py-3 font-medium border-b-2 border-transparent hover:bg-gray-50">
              ‚úçÔ∏è Cr√©er
            </button>
            <button onclick="switchTab('import')" id="tab-import" class="flex-1 px-6 py-3 font-medium border-b-2 border-transparent hover:bg-gray-50">
              üì• Import CSV
            </button>
            <button onclick="switchTab('scrape')" id="tab-scrape" class="flex-1 px-6 py-3 font-medium border-b-2 border-transparent hover:bg-gray-50">
              üï∑Ô∏è Scraper
            </button>
            <button onclick="switchTab('extract')" id="tab-extract" class="flex-1 px-6 py-3 font-medium border-b-2 border-transparent hover:bg-gray-50">
              ü§ñ Extraction IA
            </button>
          </div>
        </div>

        <!-- Tab Content: Jobs List -->
        <div id="content-jobs" class="tab-content">
          <div class="bg-white rounded-lg border p-6 shadow-sm">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-xl font-semibold">Liste des annonces</h2>
              <button onclick="loadJobs()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">Rafra√Æchir</button>
            </div>
            <div id="jobs-list" class="space-y-3"></div>
          </div>
        </div>

        <!-- Tab Content: Create Job -->
        <div id="content-create" class="tab-content" style="display: none;">
          <div class="bg-white rounded-lg border p-6 shadow-sm">
            <h2 class="text-xl font-semibold mb-4">Cr√©er une annonce manuellement</h2>
            <form onsubmit="createJob(event)" class="space-y-4">
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium mb-1">Titre *</label>
                  <input type="text" id="create-title" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Serveur">
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">R√¥le</label>
                  <input type="text" id="create-role" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Serveur">
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">Ville</label>
                  <input type="text" id="create-city" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Paris">
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">Date</label>
                  <input type="text" id="create-date" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Samedi 7 mars">
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">Horaires</label>
                  <input type="text" id="create-duration" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="18h-23h">
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">Salaire</label>
                  <input type="text" id="create-hourly" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="15‚Ç¨/h">
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium mb-1">Description</label>
                <textarea id="create-body" rows="4" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Description compl√®te de l'annonce..."></textarea>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium mb-1">Entreprise</label>
                  <input type="text" id="create-company" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Restaurant X">
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">Contact</label>
                  <input type="text" id="create-name" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="John Doe">
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">Email</label>
                  <input type="email" id="create-email" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="contact@example.com">
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">T√©l√©phone</label>
                  <input type="tel" id="create-phone" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="+33612345678">
                </div>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium mb-1">Statut</label>
                  <select id="create-status" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="approved">Approuv√©</option>
                    <option value="pending">En attente</option>
                    <option value="rejected">Rejet√©</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">Source</label>
                  <input type="text" id="create-source" value="manual" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="manual">
                </div>
              </div>

              <div class="flex gap-2">
                <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">Cr√©er l'annonce</button>
                <button type="button" onclick="resetCreateForm()" class="px-6 py-2 border rounded-lg hover:bg-gray-50 font-medium">R√©initialiser</button>
              </div>
              <div id="create-message" class="text-sm"></div>
            </form>
          </div>
        </div>

        <!-- Tab Content: Import CSV -->
        <div id="content-import" class="tab-content" style="display: none;">
          <div class="bg-white rounded-lg border p-6 shadow-sm">
            <h2 class="text-xl font-semibold mb-4">Import CSV en masse</h2>
            <div class="space-y-4">
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <p class="text-sm font-medium mb-2">Format CSV attendu:</p>
                <code class="text-xs bg-white px-2 py-1 rounded block overflow-x-auto">
title,body,role,city,date,duration,hourly,company,name,email,phone,status,source
                </code>
              </div>

              <div>
                <label class="block text-sm font-medium mb-2">Coller votre CSV ici:</label>
                <textarea id="import-csv" rows="10" class="w-full px-3 py-2 border rounded-lg font-mono text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="title,body,role,city,date,duration,hourly,company,name,email,phone,status,source&#10;Serveur,Description,Serveur,Paris,Samedi,18h-23h,15‚Ç¨/h,Restaurant,John,john@example.com,+33612345678,approved,import"></textarea>
              </div>

              <div>
                <button onclick="importCSV()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">Importer le CSV</button>
              </div>
              <div id="import-message" class="text-sm"></div>
            </div>
          </div>
        </div>

        <!-- Tab Content: Scrape URL -->
        <div id="content-scrape" class="tab-content" style="display: none;">
          <div class="bg-white rounded-lg border p-6 shadow-sm">
            <h2 class="text-xl font-semibold mb-4">Scraper une annonce depuis une URL</h2>
            <div class="space-y-4">
              <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <p class="text-sm">
                  <strong>Note:</strong> Entrez l'URL d'une page contenant une annonce. Le syst√®me va extraire automatiquement le contenu et cr√©er une annonce.
                </p>
              </div>

              <div>
                <label class="block text-sm font-medium mb-1">URL de l'annonce</label>
                <input type="url" id="scrape-url" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="https://example.com/job-listing">
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium mb-1">Statut apr√®s import</label>
                  <select id="scrape-status" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="approved">Approuv√©</option>
                    <option value="pending">En attente</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">Source</label>
                  <input type="text" id="scrape-source" value="scrape" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
              </div>

              <div>
                <button onclick="scrapeURL()" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-medium">Scraper l'URL</button>
              </div>
              <div id="scrape-message" class="text-sm"></div>
            </div>
          </div>
        </div>

        <!-- Tab Content: AI Extraction -->
        <div id="content-extract" class="tab-content" style="display: none;">
          <div class="bg-white rounded-lg border p-6 shadow-sm">
            <h2 class="text-xl font-semibold mb-4">Extraction IA (OpenAI)</h2>
            <div class="space-y-4">
              <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                <p class="text-sm">
                  <strong>ü§ñ Intelligence Artificielle</strong><br>
                  Collez un texte brut et l'IA va extraire automatiquement: r√¥le, ville, date, horaires et salaire.
                </p>
              </div>

              <div>
                <label class="block text-sm font-medium mb-1">Texte √† analyser</label>
                <textarea id="extract-text" rows="4" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Exemple: Cherche serveur √† Paris samedi 7 mars de 18h √† 23h pay√© 15‚Ç¨/h"></textarea>
              </div>

              <div>
                <button onclick="extractJobData()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">Extraire les donn√©es</button>
              </div>

              <div id="extract-result" class="hidden">
                <div class="border-t pt-4 mt-4">
                  <h3 class="font-medium mb-3">R√©sultat de l'extraction:</h3>
                  <div class="grid grid-cols-2 gap-3 bg-gray-50 p-4 rounded-lg">
                    <div>
                      <span class="text-sm text-gray-600">R√¥le:</span>
                      <p class="font-medium" id="extracted-role"></p>
                    </div>
                    <div>
                      <span class="text-sm text-gray-600">Ville:</span>
                      <p class="font-medium" id="extracted-city"></p>
                    </div>
                    <div>
                      <span class="text-sm text-gray-600">Date:</span>
                      <p class="font-medium" id="extracted-date"></p>
                    </div>
                    <div>
                      <span class="text-sm text-gray-600">Horaires:</span>
                      <p class="font-medium" id="extracted-duration"></p>
                    </div>
                    <div>
                      <span class="text-sm text-gray-600">Salaire:</span>
                      <p class="font-medium" id="extracted-hourly"></p>
                    </div>
                  </div>
                </div>
              </div>
              <div id="extract-message" class="text-sm"></div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://dxslenzfyqqtxylotcmm.supabase.co';
    let adminToken = localStorage.getItem('admin_token');
    let currentAdmin = null;

    if (adminToken) {
      checkSession();
    }

    async function register() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const msg = document.getElementById('auth-message');

      if (!email || !password) {
        msg.innerHTML = '<span class="text-red-600">‚ö†Ô∏è Email et mot de passe requis</span>';
        return;
      }

      if (password.length < 6) {
        msg.innerHTML = '<span class="text-red-600">‚ö†Ô∏è Mot de passe trop court (min 6 caract√®res)</span>';
        return;
      }

      try {
        msg.innerHTML = '<span class="text-gray-600">‚è≥ Inscription en cours...</span>';

        const response = await fetch(`${SUPABASE_URL}/functions/v1/admin-auth/register`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(adminToken ? { 'Authorization': `Bearer ${adminToken}` } : {})
          },
          body: JSON.stringify({ email, password })
        });

        const data = await response.json();

        if (!response.ok) {
          if (data.error === 'email_exists') {
            msg.innerHTML = '<span class="text-red-600">‚ö†Ô∏è Cet email existe d√©j√†. Essayez de vous connecter.</span>';
          } else if (data.error === 'admin_required') {
            msg.innerHTML = '<span class="text-red-600">‚ö†Ô∏è Un admin existant doit vous cr√©er un compte.</span>';
          } else {
            msg.innerHTML = `<span class="text-red-600">‚ö†Ô∏è ${data.error}</span>`;
          }
          return;
        }

        if (data.token) {
          adminToken = data.token;
          localStorage.setItem('admin_token', adminToken);
          currentAdmin = data.admin;
          showDashboard();
          msg.innerHTML = '<span class="text-green-600">‚úÖ Compte cr√©√© avec succ√®s!</span>';
        }
      } catch (error) {
        msg.innerHTML = `<span class="text-red-600">‚ö†Ô∏è Erreur: ${error.message}</span>`;
      }
    }

    async function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const msg = document.getElementById('auth-message');

      if (!email || !password) {
        msg.innerHTML = '<span class="text-red-600">‚ö†Ô∏è Email et mot de passe requis</span>';
        return;
      }

      try {
        msg.innerHTML = '<span class="text-gray-600">‚è≥ Connexion en cours...</span>';

        const response = await fetch(`${SUPABASE_URL}/functions/v1/admin-auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });const SUPABASE_URL = 'https://gywhqtlebvvauxzmdavb.supabase.co';

        const data = await response.json();

        if (!response.ok) {
          msg.innerHTML = `<span class="text-red-600">‚ö†Ô∏è ${data.error === 'invalid_credentials' ? 'Email ou mot de passe incorrect' : data.error}</span>`;
          return;
        }

        adminToken = data.token;
        localStorage.setItem('admin_token', adminToken);
        currentAdmin = data.admin;
        showDashboard();
        msg.innerHTML = '<span class="text-green-600">‚úÖ Connect√©!</span>';
      } catch (error) {
        msg.innerHTML = `<span class="text-red-600">‚ö†Ô∏è Erreur: ${error.message}</span>`;
      }
    }

    async function checkSession() {
      try {
        const response = await fetch(`${SUPABASE_URL}/functions/v1/admin-auth/me`, {
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });

        if (response.ok) {
          const data = await response.json();
          currentAdmin = data.admin;
          showDashboard();const response = await fetch(`${SUPABASE_URL}/functions/v1/hyper-api/register`, {
        } else {
          localStorage.removeItem('admin_token');
          adminToken = null;
        }
      } catch (error) {
        console.error('Session check failed:', error);
      }
    }

    async function logout() {
      try {
        await fetch(`${SUPABASE_URL}/functions/v1/admin-auth/logout`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });
      } catch (error) {
        console.error('Logout error:', error);
      }

      localStorage.removeItem('admin_token');
      adminToken = null;
      currentAdmin = null;
      document.getElementById('auth-section').style.display = 'block';
      document.getElementById('dashboard-section').style.display = 'none';
    }

    function showDashboard() {
      document.getElementById('auth-section').style.display = 'none';
      document.getElementById('dashboard-section').style.display = 'block';
      document.getElementById('admin-email').textContent = currentAdmin.email;
      loadJobs();
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
      document.querySelectorAll('[id^="tab-"]').forEach(el => {
        el.classList.remove('border-blue-600', 'text-blue-600');
        el.classList.add('border-transparent');
      });

      document.getElementById(`content-${tab}`).style.display = 'block';
      const response = await fetch(`${SUPABASE_URL}/functions/v1/hyper-api/me`, {
      document.getElementById(`tab-${tab}`).classList.remove('border-transparent');
    }

    async function loadJobs() {
      const list = document.getElementById('jobs-list');
      list.innerHTML = '<div class="text-sm text-gray-600">‚è≥ Chargement...</div>';

      try {
        const response = await fetch(`${SUPABASE_URL}/functions/v1/admin-jobs`, {
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });

        if (!response.ok) {
          list.innerHTML = '<div class="text-sm text-red-600">‚ö†Ô∏è Erreur de chargement</div>';
          return;
        }

        const data = await response.json();
        const jobs = data.jobs || [];

        if (jobs.length === 0) {
          list.innerHTML = '<div class="text-sm text-gray-600">Aucune annonce</div>';
          return;
        }

        list.innerHTML = jobs.map(job => `
          <div class="border rounded-lg p-4 hover:bg-gray-50">
            <div class="flex items-start justify-between mb-2">
              <div class="flex-1">
                <div class="font-medium text-lg">${job.title}</div>
                <div class="text-sm text-gray-600 mt-1">
                  ${job.parsed?.city || '‚Äî'} ‚Ä¢ ${job.parsed?.date || '‚Äî'} ‚Ä¢ ${job.parsed?.duration || '‚Äî'} ‚Ä¢ ${job.parsed?.hourly || '‚Äî'}
                </div>
              </div>
              <span class="px-3 py-1 text-xs rounded-full font-medium ${
                job.status === 'approved' ? 'bg-green-100 text-green-700' :
                job.status === 'rejected' ? 'bg-red-100 text-red-700' :
                'bg-yellow-100 text-yellow-700'
              }">${job.status}</span>
            </div>
            <div class="text-sm text-gray-700 mb-3">${job.body?.slice(0, 200) || ''}${job.body?.length > 200 ? '...' : ''}</div>
            <div class="text-xs text-gray-500 mb-3">
              üìß ${job.contact?.email || '‚Äî'} ‚Ä¢ üìû ${job.contact?.phone || '‚Äî'} ‚Ä¢ üè¢ ${job.contact?.company || '‚Äî'}
            </div>
            <div class="text-xs text-gray-400 mb-3">
              Source: ${job.source || 'unknown'} ‚Ä¢ Cr√©√©: ${new Date(job.created_at).toLocaleDateString('fr-FR')}
            </div>
            <div class="flex gap-2">
              ${job.status !== 'approved' ? `<button onclick="updateStatus('${job.id}', 'approved')" class="px-3 py-1.5 text-xs bg-green-600 text-white rounded hover:bg-green-700 font-medium">‚úì Approuver</button>` : ''}
              ${job.status !== 'rejected' ? `<button onclick="updateStatus('${job.id}', 'rejected')" class="px-3 py-1.5 text-xs bg-red-600 text-white rounded hover:bg-red-700 font-medium">‚úó Rejeter</button>` : ''}
              <button onclick="deleteJob('${job.id}')" class="px-3 py-1.5 text-xs border border-red-600 text-red-600 rounded hover:bg-red-50 font-medium">üóë Supprimer</button>
            </div>
          </div>
        `).join('');
      } catch (error) {
        list.innerHTML = `<div class="text-sm text-red-600">‚ö†Ô∏è Erreur: ${error.message}</div>`;
      }
    }

    async function updateStatus(jobId, status) {
      try {
        const response = await fetch(`${SUPABASE_URL}/functions/v1/admin-jobs/${jobId}/status`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${adminToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ status })
        });
await fetch(`${SUPABASE_URL}/functions/v1/hyper-api/logout`, {
        if (response.ok) {
          loadJobs();
        } else {
          alert('Erreur lors de la mise √† jour');
        }
      } catch (error) {
        alert('Erreur: ' + error.message);
      }
    }

    async function deleteJob(jobId) {
      if (!confirm('Supprimer cette annonce d√©finitivement ?')) return;

      try {
        const response = await fetch(`${SUPABASE_URL}/functions/v1/admin-jobs/${jobId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });

        if (response.ok) {
          loadJobs();
        } else {
          alert('Erreur lors de la suppression');
        }
      } catch (error) {
        alert('Erreur: ' + error.message);
      }
    }

    async function createJob(event) {
      event.preventDefault();
      const msg = document.getElementById('create-message');
      msg.innerHTML = '<span class="text-gray-600">‚è≥ Cr√©ation en cours...</span>';

      try {
        const job = {
          title: document.getElementById('create-title').value,
          body: document.getElementById('create-body').value,
          parsed: {
            role: document.getElementById('create-role').value,
            city: document.getElementById('create-city').value,
            date: document.getElementById('create-date').value,
            duration: document.getElementById('create-duration').value,
            hourly: document.getElementById('create-hourly').value
          },
          contact: {
            company: document.getElementById('create-company').value,
            name: document.getElementById('create-name').value,
            email: document.getElementById('create-email').value,
            phone: document.getElementById('create-phone').value
          },
          status: document.getElementById('create-status').value,
          source: document.getElementById('create-source').value
        };

        const response = await fetch(`${SUPABASE_URL}/functions/v1/admin-jobs`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${adminToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(job)
        });

        if (!response.ok) {
          const error = await response.json();
          msg.innerHTML = `<span class="text-red-600">‚ö†Ô∏è ${error.error}</span>`;
          return;
        }

        msg.innerHTML = '<span class="text-green-600">‚úÖ Annonce cr√©√©e avec succ√®s!</span>';
        resetCreateForm();
        setTimeout(() => {
          switchTab('jobs');
          loadJobs();
        }, 1500);
      } catch (error) {
        msg.innerHTML = `<span class="text-red-600">‚ö†Ô∏è Erreur: ${error.message}</span>`;
      }
    }

    function resetCreateForm() {
      document.getElementById('create-title').value = '';
      document.getElementById('create-body').value = '';
      document.getElementById('create-role').value = '';
      document.getElementById('create-city').value = '';
      document.getElementById('create-date').value = '';
      document.getElementById('create-duration').value = '';
      document.getElementById('create-hourly').value = '';
      document.getElementById('create-company').value = '';
      document.getElementById('create-name').value = '';
      document.getElementById('create-email').value = '';
      document.getElementById('create-phone').value = '';
      document.getElementById('create-status').value = 'approved';
      document.getElementById('create-source').value = 'manual';
      document.getElementById('create-message').innerHTML = '';
    }

    async function importCSV() {
      const csv = document.getElementById('import-csv').value;
      const msg = document.getElementById('import-message');

      if (!csv.trim()) {
        msg.innerHTML = '<span class="text-red-600">‚ö†Ô∏è Veuillez coller un CSV</span>';
        return;
      }

      msg.innerHTML = '<span class="text-gray-600">‚è≥ Import en cours...</span>';

      try {
        const response = await fetch(`${SUPABASE_URL}/functions/v1/admin-import/csv`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${adminToken}`,
            'Content-Type': 'text/csv'
          },
          body: csv
        });

        if (!response.ok) {
          const error = await response.json();
          msg.innerHTML = `<span class="text-red-600">‚ö†Ô∏è ${error.error}</span>`;
          return;
        }

        const data = await response.json();
        msg.innerHTML = `<span class="text-green-600">‚úÖ ${data.imported} annonce(s) import√©e(s) avec succ√®s!</span>`;
        document.getElementById('import-csv').value = '';

        setTimeout(() => {
          switchTab('jobs');
          loadJobs();
        }, 2000);
      } catch (error) {
        msg.innerHTML = `<span class="text-red-600">‚ö†Ô∏è Erreur: ${error.message}</span>`;
      }
    }

    async function scrapeURL() {
      const url = document.getElementById('scrape-url').value;
      const status = document.getElementById('scrape-status').value;
      const source = document.getElementById('scrape-source').value;
      const msg = document.getElementById('scrape-message');

      if (!url.trim()) {
        msg.innerHTML = '<span class="text-red-600">‚ö†Ô∏è Veuillez entrer une URL</span>';
        return;
      }

      msg.innerHTML = '<span class="text-gray-600">‚è≥ Scraping en cours...</span>';

      try {
        const response = await fetch(`${SUPABASE_URL}/functions/v1/admin-import/scrape`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${adminToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ url, status, source })
        });

        if (!response.ok) {
          const error = await response.json();
          msg.innerHTML = `<span class="text-red-600">‚ö†Ô∏è ${error.error}</span>`;
          return;
        }

        const data = await response.json();
        msg.innerHTML = '<span class="text-green-600">‚úÖ Annonce scrap√©e et cr√©√©e avec succ√®s!</span>';
        document.getElementById('scrape-url').value = '';

        setTimeout(() => {
          switchTab('jobs');
          loadJobs();
        }, 2000);
      } catch (error) {
        msg.innerHTML = `<span class="text-red-600">‚ö†Ô∏è Erreur: ${error.message}</span>`;
      }
    }

    async function extractJobData() {
      const text = document.getElementById('extract-text').value;
      const msg = document.getElementById('extract-message');

      if (!text.trim()) {
        msg.innerHTML = '<span class="text-red-600">‚ö†Ô∏è Veuillez entrer un texte √† analyser</span>';
        return;
      }

      msg.innerHTML = '<span class="text-gray-600">‚è≥ Extraction en cours...</span>';

      try {
        const response = await fetch(`${SUPABASE_URL}/functions/v1/uwi-extract`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt: text })
        });

        if (!response.ok) {
          const error = await response.json();
          msg.innerHTML = `<span class="text-red-600">‚ö†Ô∏è ${error.error}</span>`;
          return;
        }

        const data = await response.json();

        document.getElementById('extracted-role').textContent = data.role || '‚Äî';
        document.getElementById('extracted-city').textContent = data.city || '‚Äî';
        document.getElementById('extracted-date').textContent = data.date || '‚Äî';
        document.getElementById('extracted-duration').textContent = data.duration || '‚Äî';
        document.getElementById('extracted-hourly').textContent = data.hourly || '‚Äî';

        document.getElementById('extract-result').classList.remove('hidden');
        msg.innerHTML = '<span class="text-green-600">‚úÖ Extraction r√©ussie!</span>';
      } catch (error) {
        msg.innerHTML = `<span class="text-red-600">‚ö†Ô∏è Erreur: ${error.message}</span>`;
      }
    }
  </script>
</body>
</html>
